### IP 协议

#### 1. 协议头格式如下：

![IP协议格式](https://raw.githubusercontent.com/yimu-0412/image/master/image/IP%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F.png)

* **4位版本号（version）**：指定IP协议的版本，对于IPv4来说，就是4。
  
* **4位首部长度（header length）**：IP的头部长度是多少个32bit，也就是length*4的字节数。4bit表示的最大数是15，因此IP头部最大长度是60字节。
  
* **8位服务类型（TOS）**：3位优先权字段（已经弃用），4位TOS字段，和1位保留
字段（必须置为0）。4位TOS分别表示：最小延时，最大吞吐量，最高可靠性，最小成本。这四者相互冲突，只能选择一个。

* **16位总长度（total length）**：IP数据报整体占多少字节。IP协议内置了分包组包功能，如果数据很长，IP 协议就会自动拆解成多个数据报，然后进行传输。接收方会进行重新组包。
  
* **16位标识（id）**：唯一的标识主机发送的报文。如果一个数据拆成了多个 IP 数据报的时候，这些数据报的标识是相同的。
  
* **3位标志字段**:第一位保留（保留的意思是现在不用，但是还没想好说不定以后要用到）。第二位置为1表示禁止分片，这时候如果报文长度超过MTU，IP模块就会丢弃报文。第三位表示"更多分片"，如果分片了的话，最后一个分片置为1，其他是0。类似于一个结束标记。
  
* **13位片偏移（framegament offset）**：是分片相对于原始IP报文开始处的偏移。其实就是在表示当前分片在原报文中处在哪个位置。实际偏移的字节数是这个值 * 8 得到的。因此，除了最后一个报文之外，其他报文的长度必须是8的整数倍（否则报文就不连续了）。
  
* **8位生存时间（TTL）**：数据报到达目的地的最大报文跳数。一般是64，每次经过一个路由，TTL 就减1，如果到0还没有到达，数据就丢弃。这个字段主要用来防止出现路由循环。

* **8位协议**：表示上层协议的类型。当前的数据被接收方接收之后，分用的时候要把载荷内容交给传输层的哪一个协议。

![IP协议-8位协议](https://raw.githubusercontent.com/yimu-0412/image/master/image/IP%E5%8D%8F%E8%AE%AE-8%E4%BD%8D%E5%8D%8F%E8%AE%AE.png)

&emsp;&emsp;图中接收方接收到这份数据之后，会进行解析（分用），根据8位协议就会把这个数据报交给 UDP 协议来解析。8位协议的具体内容为多少，需要查询 RFC 标准文档。

* **16位首部校验和**：使用 CRC 进行校验，用来**鉴别头部**是否损坏。载荷部分（一个完整的 TCP/UDP 数据报）其实由 TCP/UDP 自己进行校验了。
  
* **32位源地址和32位目标地址**：表示发送端和接收端的地址。

#### 2. **IP 协议的核心功能**
   
   1. 地址管理：经过一系列的规则，把网络上的设备地址描述出来。
   2. 路由选择：根据当下的源地址和目的地址，规划一条合适的路径。


  

