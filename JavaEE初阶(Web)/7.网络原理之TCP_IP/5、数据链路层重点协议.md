### 一、认识以太网

&emsp;&emsp;“以太网”不是一种具体的网络，而是一种技术标准；即包含了数据链路层的内容，也包含了一些物理层的内容。例如：规定了网络拓扑结构，访问控制方式，传输速率等；

&emsp;&emsp;例如以太网的网线必须使用双绞线；传输速率有10M、100M、1000M等；

&emsp;&emsp;以太网是引用最广泛的局域网技术；和以太网并列的还有令牌环网，无线 LAN 等；

#### **1. 以太网帧格式**

&emsp;&emsp;以太网帧格式如下所示：

![以太网帧格式](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)

* 源地址和目的地址是指网卡的硬件地址（也叫MAC地址），长度是48位，是网卡出厂时固化的。
* 帧协议字段一般有三种值，分别对应IP、ARP、RARP。
* 末尾是 CRC 校验码。
### 二、认识 MTU

&emsp;&emsp;物理层是存在这样的硬性限制的，对应的数据链路层的数据帧，是有一定的大小范围的，这个范围值得就是 MTU。

        1.以太网帧中的数据长度规定最小46字节，最大1500字节，ARP 的数据包长度不够46字节，要在后面填补充位。
        2. 最大值1500称为以太网的最大传输单元（MTU），不同的类型具有不同的 MTU。
        3. 如果一个数据包从以太网路由到拨号链路上，数据包长度大于拨号链路的 MTU 了，则需要对数据包进行分片。
        4. 不同的数据链路层标准的 MTU 是不同的。
#### **1. MTU 对 IP 协议的影响**

&emsp;&emsp;由于数据链路层 MTU 的限制，对于较大的 IP 数据包要进行分片。

        1.将较大的包分成多个小包，并给每个小包打上标签；
        2.每个小包 IP 协议头的16位标识（id）都是相同的；
        3.每个小包 IP 协议头的3位标志字段中，第二位置为0，表示允许分片，第三位来表示结束标记（当前是否是最后一个小包，是的话置为1，否则置为0）；
        4.到达对端时再将这些小包，会按顺序重组，拼装到一起返回给传输层；
        5.一旦这些小包中任意一个丢失，接收端的重组就会失败，**但是IP层不会负责重传数据**。 

![MTU 对 IP的影响举例](https://raw.githubusercontent.com/yimu-0412/image/master/image/MTU%20%E5%AF%B9%20IP%E7%9A%84%E5%BD%B1%E5%93%8D%E4%B8%BE%E4%BE%8B.png)

![MTU 对 IP 协议的影响过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/MTU%20%E5%AF%B9%20IP%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%BD%B1%E5%93%8D%E8%BF%87%E7%A8%8B.png)

#### **2. MTU 对 UDP 协议的影响**

1. 一旦UDP携带的数据超过1472（1500 - 20（IP首部） - 8（UDP首部）），那么就会在网络层分成多个IP数据报。

2. 这多个 IP 数据报有任意一个丢失，都会引起接收端网络层重组失败。那么这就意味着，如果UDP数据报在网络层被分片，整个数据被丢失的概率就大大增加了。

#### **3. MTU 对 TCP 协议的影响**

* TCP 的一个数据报也不能无限大，还是受制于 MTU。TCP 的单个数据报的最大消息长度，称为 MSS（Max Segment Size）。
* TCP 在建立连接的过程中，通信双方会进行 MSS 协商。
* 最理想的情况下，MSS 的值正好是在 IP 不会被分片处理的最大长度（这个长度仍然受制于数据链路层的 MTU）。
* 双方在发送 SYN 的时候会在 TCP 头部写入自己能支持的 MSS 值；
* 然后双方得知对方的 MSS 值之后，选择较小的作为最终 MSS。
* MSS 就是在 TCP 首部的40字节变长选项中（kind - 2）；

**MSS和MTU的关系**：
![MTU 和 MSS的关系](https://raw.githubusercontent.com/yimu-0412/image/master/image/MTU%20%E5%92%8C%20MSS%E7%9A%84%E5%85%B3%E7%B3%BB.png)

* **MTU= MSS+TCP层头部长度+IP层头部长度** （MSS是指应用层在一个数据包内最大能传输的字节数，MTU是指IP层在一个数据包内最大能传输的字节数）
* 
### 三、ARP 协议

&emsp;&emsp;ARP协议不单纯是一个数据链路层的协议，而是一个**介于数据链路层和网络层之间的协议**。

#### **1. ARP 协议的作用**

&emsp;&emsp;**ARP 协议建立了主机 IP地址 和 MAC地址 之间的映射关系**。

        1.在网络通信时，源主机的应用程序知道目的主机的 IP地址 和端口号，却不知道硬件主机的硬件地址（MAC地址）；
        2. 数据包首先是被网卡接收再去处理上层协议的，如果接收的数据包硬件地址（MAC地址）和硬件地址不符，则直接丢弃；
        3. 因此通讯前必须获得目的主机的硬件地址。
   
#### **2. ARP 协议的工作流程**

![ARP协议的工作过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/ARP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png)

* 源主机发出ARP请求，询问“IP地址是192.168.0.1的主机的硬件地址是多少”，并将这个请求广播到本地网段（以太网帧首部的硬件地址填FF:FF:FF:FF:FF:FF表示广播）；
* 目的主机接收到广播的ARP请求，发现其中的IP地址与本机相符，则发送一个ARP应答数据包给源主机，将自己的硬件地址填写在应答包中；
* 每台主机都维护一个ARP缓存表，可以用arp -a命令查看。缓存表中的表项有过期时间（一般为20分钟），如果20分钟内没有再次使用某个表项，则该表项失效，下次还要发ARP请求来获得目的主机的硬件地址