### 一、认识 IP 地址

#### **1.概念**

&emsp;&emsp;IP 地址（Internet Protocal Address）是指互联网协议地址，又译为网际协议地址。

#### **2.作用**

&emsp;&emsp;IP地址是IP协议提供的一种统一的地址格式，为互联网上每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。**IP地址主要用于标识网络主机、其他网络设备（如路由器）的网络地址**。简单来说，IP地址就是用来**定位主机的网络地址**。

#### **3.格式**

&emsp;&emsp;IP 地址是一个32位的二进制数，通常被分割为“4个8位的二进制数”（也就是4个字节）。

&emsp;&emsp;通常用**点分十进制**的方式来表示，即a.b.c.d（a,b,c,d都是0~255之间的十进制数），如：100.4.5.6。

        IP协议有两个版本，IPv4 和 IPv6。
        IPv4 的数量=2^32,大约43亿左右，而TCP/IP 协议规定，每个主机都要有一个IP地址。对于目前全世界的计算机来说，这个数量是不够的，所以推出了 IPv6（长度是128位，是IPv4 的是4倍），但是IPv6目前还没有被普及。
#### **4.组成**

&emsp;&emsp;IP 地址分为两部分，网络号和主机号。
   
   1. **网络号**：**标识网段**，保证相互连接的两个网段具有不同的标识。
   2. **主机号**：**标识主机**，同一网段内，主机具有相同的网络号，但是必须有不同的主机号。

&emsp;&emsp;通过合理的网络号和主机号，就可以保证相互连接的两个网络中，每台主机的IP地址都是**唯一的**。

#### **5.分类**

&emsp;&emsp;曾经提出了一种划分网络号和主机号的方案，把所有的IP地址分为五类。如下图所示：

![IP 地址分类](https://raw.githubusercontent.com/yimu-0412/image/master/image/IP%20%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB.png)

各类地址的表示范围：

![IP地址分类的表示范围](https://raw.githubusercontent.com/yimu-0412/image/master/image/IP%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB%E7%9A%84%E8%A1%A8%E7%A4%BA%E8%8C%83%E5%9B%B4.png)

**注**：主机最大连接数减去2，是扣除主机号为全0和全1的特殊IP地址。

**特殊的IP地址**

* 将IP地址中的主机号全部设为0，就会变成网络号，代表整个局域网。
  
* 将IP地址中的主机号全部设为1，就会变成广播地址，用于给同一链路中相互连接的所有主机发送数据包。
  
* 127.*的IP地址用于本机环回（look back）测试，通常为127.0.0.1。
  
* 本机环回主要用于本机到本机的网络通信（系统内部为了性能，不会走网络的方式传输），对于开发网络同心度程序（网络编程），常见的开发方式就是本机到本机的网络通信。

### 二、子网掩码

#### **1.格式**

&emsp;&emsp;与IP地址格式一样，也是一个32位的二进制数。其中左边是网络位，用数字“1”表示，1的长度等于网络位的长度；右边是主机位，用数字“0”表示，0的数目与主机位相同。
#### **2.作用**

1. 屏蔽IP地址的一部分以区别网络标识和主机标识，并说明该IP地址在局域网上还是远程网上。
2. 将一个大的IP网络划分成若干个小的子网络。

#### **3.计算方式**

&emsp;&emsp;将子网掩码和IP地址进行“**按位与**”操作（**二进制相同位，与操作，两个都是1结果为1，否则为0**），得到的结果就是网络号。

&emsp;&emsp;将子网掩码二进制位按位取反，在与IP地址进行与计算，得到的就是主机号。

**示例：**

![子网掩码示例](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E7%A4%BA%E4%BE%8B.png)

### 三、认识 MAC 地址

&emsp;&emsp;MAC,即Media Access Control Address。**用来标识网络设备的硬件物理地址**。

* 主机具有一个或者多个网卡，路由器具有两个或两个以上的网卡；其中每一个网卡都具有单独的 MAC 地址。
  
* 网络通讯，即网络数据传输，本质上就是**网络硬件设备，将数据发送到网卡上，或从网卡接收数据**。
  
* 硬件层面只能基于 MAC 地址识别网络设备的网络物理地址。
  
   - MAC 地址用来识别数据链路层中相连的节点
   - 长度为48位，即6个字节。一般使用16进制数字加上冒号的形式表示。（例如：08:00:27:03:fb:19） 
   - 网卡在出厂时就确定了，不可更改。虚拟机中的 MAC 地址不是真实的 MAC 地址，可能会冲突。也有些网卡支持用户配置MAC 地址。

**特殊的MAC地址**

&emsp;&emsp;广播数据报：发送一个广播数据报，表示对网段所有主机发送数据报。广播数据报的 MAC 地址:FF:FF:FF:FF:FF:FF。

**一跳一跳的网络数剧传输**

&emsp;&emsp;以下为主机B传输数据到主机C经过的网络设备：

![数据传输过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BF%87%E7%A8%8B.png)

对于以上经过的网络设备:

* 主机:配有IP地址,但是不进行路由控制的设备;

* 路由器:即配有 IP 地址,又能进行路由控制;

* 节点:主机和路由器的统称。

      集线器和二层交换机不会对数据进行封装和分用，不算下一跳设备。

**总结 IP 地址和 MAC 地址**

* IP 地址描述的是**路途总体的起点和重点**：是给人使用的网络逻辑地点。
* MAC 地址描述的是路途上的每一个起点和终点，即**每一跳的起点和终点**；是给网络硬件设备使用的网络物理地址。

### 四、网络设备及相关技术

#### **1.集线器：转发所有端口**

&emsp;&emsp;集线器是工作在物理层的网络设备，发送到集线器的任何数据，都只是简单的将数据复制并**转发到其他所有的端口**。（端口指集线器后面的物理端口）

![集线器](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E9%9B%86%E7%BA%BF%E5%99%A8.png)

#### **2.交换机：MAC 地址转换表 + 转发对应接口**

&emsp;&emsp;交换机工作在数据链路层，交换机内部会记录并维护一张**MAC地址转换表**。

   1. MAC地址转换表主要记录**MAC地址与端口之间的映射**。
   2. 主机连接到交换机，及主机发送数据的时候，交换机可以学习并记录主机MAC地址和端口信息。
   3. 交换机接收数据之后，在MAC转换表中，通过目的MAC查找对应的端口，则目的主机为该端口相连接的主机，只需要将数据报**转发到对应端口上**即可。
   4. 下图是使用MAC地址转换表，通过目的MAC找对应端口的情况：如果找不到，交换机设置数据报**目的MAC**为广播地址FF:FF:FF:FF:FF,发送到其他所有端口，目的主机返回响应后交换机再记录该主机MAC与端口的映射信息。

![交换机工作过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png)

#### **3.主机：网络分层从上到下封装**

&emsp;&emsp;发送数据报时，发送端主机都需要先根据网络协议分层从上到下分装。

![从上到下封装](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E4%BB%8E%E4%B8%8A%E5%88%B0%E4%B8%8B%E5%B0%81%E8%A3%85.png)

&emsp;&emsp;由“一跳一跳的网络数据传输”可知，以上：
* 源IP和目的IP标识整个路程的起点和终点；
* 源MAC和目的MAC标识了每一跳的起点和终点；

&emsp;&emsp;此时设备需要发送端主机（源主机）和接收端主机（目的主机）是否在同一网段，来设置下一跳的设备：
* 源主机和目的主机在同一网段时，下一跳就是目的主机；
* 发送端主机和接收端主机不在同一网段时，发送端主机无法知道目的主机在哪里，此时会设置下一跳设备为网关设备。
  
         所谓网关，我们这里可以简单理解为，不同网段的网络互连时，需要使用网关设备。
         通常的网关设备是路由器，可以划分公网和局域网（内网），同时还可以把局域网划分为多个子网（不同网段）
         Windows中，可以在网络设置中，更改适配器设置查看网关IP： 

![默认网关](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3.png)

&emsp;&emsp;以上两种情况，下一跳设备IP地址都可以获取到，但该设备的MAC地址（即目的MAC）可能不知道，就需要使用以下ARP寻址：

**主机&路由器：ARP缓存表+ARP寻址**

&emsp;&emsp;首先ARP是一个介于数据链路层和网络层之间的协议；ARP协议建立了IP地址和MAC地址之间的映射关系。

&emsp;&emsp;在数据链路层寻找下一跳设备MAC地址的过程，称为**ARP寻址**。

1. 主机和路由器中都保存了一张ARP缓存表：通过IP地址可以找到对应的MAC地址。
2. 根据下一跳设备的IP地址，在ARP缓存表中能找到对应的MAC地址，则可以设置目的MAC并发送数据报。
3. 如果找不到，则发送ARP广播数据报：目的MAC位广播地址，询问下一跳设备的MAC地址。

参见一下流程：

![ARP寻址](https://raw.githubusercontent.com/yimu-0412/image/master/image/ARP%E5%AF%BB%E5%9D%80.png)

#### **4.路由器:路由 + NAPT**

**路由器主要有两个作用**：

1. 网关
   
   &emsp;&emsp;路由器作为网关，可以划分公网和局域网，某些路由器还可以将局域网划分为多个子网。

         公网端口即WAN口，为单独的网口，具有公网IP地址和公网MAC地址。
         划分的多个子网，是由局域网端口即LAN口划分，每个端口都有单独的网卡，具有该网段IP地址和MAC地址。
         了解：家庭用的路由器不能划分局域网子网，企业级专业路由器才能划分。

![路由器划分子网](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91.png)

&emsp;&emsp;&emsp;&emsp;路由器作为网关：

   &emsp;&emsp;&emsp;&emsp;1. 划分局域网多个子网时，可以直接通过ARP寻址找到局域网任意主机。（这里的局域网就是路由器下的多个子网组成的局域网）。
   
   &emsp;&emsp;&emsp;&emsp;2. 划分公网和局域网时，局域网内主机发送数据报到公网主机时，需要基于NAPT协议，将局域网主机的IP地址和端口号，转换为路由器公网IP和端口号（指路由器中运行的程序的端口）。

            局域网IP+端口需要转换为公网IP+端口，原因是接收端返回的响应数据报，目的IP和目的端口无法使用局域网IP和端口。

2. 路由
   
&emsp;&emsp;所谓路由，即在复杂的网络结构中，找出一条通往终点的路线；

&emsp;&emsp;网络通信（网络数据传输），路由器中的路由功能，就类似于规划路线，往哪个方向行进能更快到达目的地。

#### **5.冲突域**

&emsp;&emsp;主机之间通过网络设备（集线器、交换机）的物理端口、网线相连时，两个主机在**同一时刻同时发送数据报，如果存在冲突，则该网络范围为一个冲突域（Collision Domain）**。

&emsp;&emsp;**冲突域是基于第一物理层，又称为碰撞域**。
&emsp;&emsp;冲突域中的网络通信，要解决冲突，就得按时间顺序来发送多个数据报：同一时刻，网络设备只能接收并转发一个数据报，多余的会丢弃，让发送端主机重新发送。

* 集线器接收到数据报后，是将数据报简单的复制、转发到其他所有端口，如果有两个数据报要同时转发，就会出现冲突。**整个集线器，即集线器的所有端口为一个冲突域**。

![集线器冲突域](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E9%9B%86%E7%BA%BF%E5%99%A8%E5%86%B2%E7%AA%81%E5%9F%9F.png)

* 交换机接收到数据报后，是将数据报转发到对应的一个端口：两个数据报同时转发到不同端口不存在冲突，但同时转发到一个端口就出现冲突。**即交换机可以分割冲突域，分割后，一个端口为一个冲突域**。

![交换机冲突域](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%86%B2%E7%AA%81%E5%9F%9F.png)

#### **6.广播域**

&emsp;&emsp;广播是指某个网络中的主机同时向网络中其它所有主机发送数据（**IP、MAC地址设置为广播地址**），这个数据所能传播到的范围即为广播域（Broadcast Domain）。

&emsp;&emsp;**广播域基于第二层数据链路层。**

* 集线器接收到广播数据报，仍是简单的复制、转发到其他所有端口，所以**集线器的所有端口为一个广播域**。
      
   ![集线器广播域](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E9%9B%86%E7%BA%BF%E5%99%A8%E5%B9%BF%E6%92%AD%E5%9F%9F.png)  

* 交换机接收到广播数据报，会转发到其他所有端口；而路由器可以隔离广播域。
  
         路由器某个LAN口网卡接收到广播数据报，如果发现是同网段，则丢弃，即广播数据不会扩散到路由器以外。

![交换机广播域](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B9%BF%E6%92%AD%E5%9F%9F.png)

### 五、网络数据传输流程

#### **1.局域网传输流程：集线器**

&emsp;&emsp;使用集线器网络互联的情况下，发送端主机发送数据包时，需要**先从上到下封装数据报**。但封装时，目的MAC可能并不知道，需要先进行**ARP寻址**：

1. 发送端在本机ARP缓存表中，根据目的IP查找对应的MAC地址；
2. 如果找到，则可以在数据链路层以太网帧头中，设置目的MAC并发送数据包；
3. 如果没有找到，需要先发送ARP广播请求，让接收端，即目的主机告诉自己，目的MAC是多少；
4. 发送端更新本机ARP缓存表：保存目的IP与目的MAC的映射；
5. 有了目的MAC，就可以按照第2个步骤发送数据了。
   
&emsp;&emsp;以下为本机ARP缓存表能找到目的MAC的流程：

&emsp;&emsp;**涉及到：封装、集线器转发、ARP寻址**

![局域网传输流程：集线器](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BC%A0%E8%BE%93%E6%B5%81%E7%A8%8B%EF%BC%9A%E9%9B%86%E7%BA%BF%E5%99%A8.png)

&emsp;&emsp;如果本机ARP缓存表中找不到目的MAC，则需要先发送广播请求：

&emsp;&emsp;涉及的知识：ARP寻址，ARP广播

![局域网网络传输：集线器ARP寻址](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%B1%80%E5%9F%9F%E7%BD%91%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%EF%BC%9A%E9%9B%86%E7%BA%BF%E5%99%A8ARP%E5%AF%BB%E5%9D%80.png)

#### **2.局域网传输流程：交换机**

&emsp;&emsp;涉及的知识：**交换机MAC转换表**

![局域网传输流程：交换机](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BC%A0%E8%BE%93%E6%B5%81%E7%A8%8B%EF%BC%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA.png)

#### **3.局域网传输流程：交换机+路由器**

&emsp;&emsp涉及到知识：**子网掩码、网关**

![局域网传输流程：交换机+路由器](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BC%A0%E8%BE%93%E6%B5%81%E7%A8%8B%EF%BC%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA%2B%E8%B7%AF%E7%94%B1%E5%99%A8.png)

#### **4.广域网数据传输流程**

&emsp;&emsp涉及到知识：**DNS，NAPT，路由**

![广域网传输流程：](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%B9%BF%E5%9F%9F%E7%BD%91%E4%BC%A0%E8%BE%93%E6%B5%81%E7%A8%8B%EF%BC%9A.png)