### 一、DNS

&emsp;&emsp;DNS,即Domain Name System，域名系统。DNS 是一整套从域名映射到 IP 的系统。

&emsp;&emsp;TCP/IP 中使用 IP 地址来确定网络上的一台主机，但是IP 地址不容易记忆，且不能表示地址组织信息，于是就发明了**域名**，并通过**域名系统**来映射域名和 IP 地址。

&emsp;&emsp;域名是一个字符串，如``www.baidu.com``、``hr.nowcoder.com``。

&emsp;&emsp;域名作为一个树形结构的系统，包含多个根节点。其中：

        1. 根节点为根域名服务器，最早的 IPv4 的根域名服务器全球只有13台，IPv6 在此基础上扩充了数量。
        2. 子节点主要由各级DNS服务器，或DNS缓存构成。
           1. DNS域名服务器，即提供域名转换为IP地址的服务器。
           2. 浏览器、主机系统、路由器中都保存有DNS缓存。
           3. Windows系统的DNS缓存在 C:\Windows\System32\drivers\etc\hosts 文件中，Mac/Linux系统的DNS缓存在 /etc/hosts 文件中。   

&emsp;&emsp;网络通信发送数据的时候，如果使用的是目的主机的域名，需要先通过**域名解析**查找对应的 IP 地址：

- 域名解析的过程，可以理解为：发送端主机作为域名系统树形结构的一个子节点，通过域名信息，从下到上查找对应IP地址的过程。如果到根节点（根域名服务器）还找不到，即找不到该主机。
- 域名解析使用**DNS协议**来传输数据。DNS协议是应用层协议，基于UDP或者TCP协议来实现。

![域名解析](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90.png)
  
### 二、NAT

#### 1.技术背景

&emsp;&emsp;NAT 技术是当前解决IP地址不够用的重要手段,是路由器的一个重要功能；本质上就是使用一个IP地址，代表一批主机。

* NAT能将私有 IP 对外通信时转为全局 IP。也就是一种将**私有IP**和**全局IP**相互转化的技术方法。
* 很多学校、企业都是将每一终端设置为私有IP，而在路由器和必要的服务器上设置全局IP；
* 全局IP要求唯一，但是私有IP不需要；在不同的局域网中出现相同的私有IP是完全不影响的。

#### 2.NAT IP转换过程

![NAT-IP转换过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/NAT-IP%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B.png)

&emsp;&emsp;**NAT-IP的转换过程**：

* 客户端A 发送数据到服务器的时，NAT 会将客户端A 的IP地址 10.0.0.10(源地址) 转换为路由器的IP地址（全局IP）202.244.174.37；
* NAT路由器收到服务器返回的响应时，又会把目标IP从路由器的IP地址202.244.174.37替换回10.0.0.10；
* 在NAT路由器内部，有一张自动生成的，用于地址转换的表；
* 当 10.0.0.10 第一次向 163.221.120.9 发送数据时就会在NAT路由器内部的表中生成映射关系；

&emsp;&emsp;三类 IP 都表示局域网：

        1. 10.*；
        2. 172.16.* ~ 172.31.*；
        3. 192.168.*；

&emsp;&emsp;windows 通过 ipconfig 命令就可以看见自己的 IP。

&emsp;&emsp;NAT 机制虽然解决了 IP 地址不够用的问题，但是也引入其他的问题。比如在自己的机器上搭建一个服务器，此时想让其他用户通过外网来访问你的服务器。这个时候，做不到。自己的机器，只有局域网IP（内网IP），内网 IP 是可以重复的。其他主机没法就根据一个内网 IP 找到你的服务器（除非是在同一个局域网里）。

#### 3. NAT 技术的缺陷

&emsp;&emsp;1. 无法从NAT外部向内部服务器建立连接；

&emsp;&emsp;2. 转化表的生成和销毁都需要额外开销；

&emsp;&emsp;3. 通信过程中一旦NAT设备异常，即使存在热备，所有的TCP连接也都会断开；

### 三、NAPT 

![NAPT的转换过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/NAPT%E7%9A%84%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B.png)

&emsp;&emsp;由于NAT实现是私有IP和NAT的公共IP之间的转换，那么，私有网中同时与公共网进行通信的主机数量就受到NAT的公共IP地址数量的限制。为了克服 这种限制，NAT被进一步扩展到在进行IP地址转换的同时进行Port的转换，这就是网络地址端口转换NAPT（Network Address Port Translation）技术。

&emsp;&emsp;**NAPT与NAT的区别在于，NAPT不仅转换IP包中的IP地址，还对IP包中TCP和UDP的Port进行转换。这使得多台私有网主机利用1个NAT公共IP就可以同时和公共网进行通信。（NAPT多了对TCP和UDP的端口号的转换）**

 &emsp;&emsp;NAPT的主要优势在于，能够**使用一个全球有效IP地址获得通用性**。主要缺点在于其通信仅限于TCP或UDP。只要所有通信都采用TCP或UDP，NAPT就允许一台内部计算机访问多台外部计算机，并允许多台内部主机访问同一台外部计算机，相互之间不会发生冲突。