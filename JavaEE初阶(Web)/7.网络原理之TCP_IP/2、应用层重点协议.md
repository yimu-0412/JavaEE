### 一、DNS

&emsp;&emsp;DNS,即Domain Name System，域名系统。DNS 是一整套**从域名映射到IP的系统。**

&emsp;&emsp;TCP/IP 中使用 IP 地址来确定网络上的一台主机，但是IP 地址不容易记忆，且不能表示地址组织信息，于是就发明了**域名**，并通过**域名系统**来映射域名和 IP 地址。

&emsp;&emsp;域名是一个字符串，如``www.baidu.com``、``hr.nowcoder.com``。

&emsp;&emsp;域名作为一个树形结构的系统，包含多个根节点。其中：

        1. 根节点为根域名服务器，最早的 IPv4 的根域名服务器全球只有13台，IPv6 在此基础上扩充了数量。
        2. 子节点主要由各级DNS服务器，或DNS缓存构成。
           1. DNS域名服务器，即提供域名转换为IP地址的服务器。
           2. 浏览器、主机系统、路由器中都保存有DNS缓存。
           3. Windows系统的DNS缓存在 C:\Windows\System32\drivers\etc\hosts 文件中，Mac/Linux系统的DNS缓存在 /etc/hosts 文件中。
           4. 现在常用的 DNS 是一组专门的服务器，通过这个服务器就可以进行域名解析。   

&emsp;&emsp;网络通信发送数据的时候，如果使用的是目的主机的域名，需要先通过**域名解析**查找对应的 IP 地址：

*
    * 域名解析的过程，可以理解为：发送端主机作为域名系统树形结构的一个子节点，通过域名信息，从下到上查找对应IP地址的过程。如果到根节点（根域名服务器）还找不到，即找不到该主机。
    * 域名解析使用**DNS协议**来传输数据。DNS协议是应用层协议，**基于UDP或者TCP协议来实现**。

![域名解析](https://raw.githubusercontent.com/yimu-0412/image/master/image/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90.png)

&emsp;&emsp;全世界的这么多电脑，都需要访问 DNS 服务器！这一个 DNS 服务器显示是架不住全世界的访问请求的，那该如何处理？

1. 浏览器/客户端本身会对域名解析结果进行缓存（域名和IP 的对应关系，是可能会改变的，但是并不频繁）。这样就避免了大量不必要的 DNS 请求。

2. DNS 服务器不是只有一台，而是有很多台。这些最初的 DNS 服务器，都是由专门的组织机构来维护的。根域名服务器，这些服务器就包含了所有的 DNS 信息，如果先要申请域名，就需要获得批准，然后把这个结果放到根域名的服务器中。

3. 为了进一步的降低压力，各种网络运营商，也会构建自己的域名服务器镜像。会在国内构造一些 DNS 服务器，定期从根域名服务器同步数据。国内用户使用DNS的时候只要查国内的DNS服务器即可。每个地区，甚至是每个城市都会有自己的 DNS 服务器。
4. 针对 DNS 服务器做镜像的时候还可以按照域名进行分类：
   1. com 做一个专门的服务器
   2. org 做一个专门的服务器
   3. vip 做一个专门的服务器
   
   这样就能够保证每个服务器的数量和请求量都不是很大。
   
### 二、NAT

#### 1.技术背景

&emsp;&emsp;NAT 技术是当前解决IP地址不够用的重要手段,是路由器的一个重要功能；本质上就是使用一个IP地址，代表一批主机。

* NAT能将私有 IP 对外通信时转为全局 IP。也就是一种将**私有IP**和**全局IP**相互转化的技术方法。
* 很多学校、企业都是将每一终端设置为私有IP，而在路由器和必要的服务器上设置全局IP；
* 全局IP要求唯一，但是私有IP不需要；在不同的局域网中出现相同的私有IP是完全不影响的。

#### 2.NAT IP转换过程

![NAT-IP转换过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/NAT-IP%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B.png)

&emsp;&emsp;**NAT-IP的转换过程**：

* 客户端A 发送数据到服务器的时，NAT 会将客户端A 的IP地址 10.0.0.10(源地址) 转换为路由器的IP地址（全局IP）202.244.174.37；
* NAT路由器收到服务器返回的响应时，又会把目标IP从路由器的IP地址202.244.174.37替换回10.0.0.10；
* 在NAT路由器内部，有一张自动生成的，用于地址转换的表；
* 当 10.0.0.10 第一次向 163.221.120.9 发送数据时就会在NAT路由器内部的表中生成映射关系；

&emsp;&emsp;三类 IP 都表示局域网：

        1. 10.*；
        2. 172.16.* ~ 172.31.*；
        3. 192.168.*；

&emsp;&emsp;windows 通过 ipconfig 命令就可以看见自己的 IP。

&emsp;&emsp;NAT 机制虽然解决了 IP 地址不够用的问题，但是也引入其他的问题。比如在自己的机器上搭建一个服务器，此时想让其他用户通过外网来访问你的服务器。这个时候，做不到。自己的机器，只有局域网IP（内网IP），内网 IP 是可以重复的。其他主机没法就根据一个内网 IP 找到你的服务器（除非是在同一个局域网里）。

#### 3. NAT 技术的缺陷

&emsp;&emsp;1. 无法从NAT外部向内部服务器建立连接；

&emsp;&emsp;2. 转化表的生成和销毁都需要额外开销；

&emsp;&emsp;3. 通信过程中一旦NAT设备异常，即使存在热备，所有的TCP连接也都会断开；

### 三、NAPT 

![NAPT的转换过程](https://raw.githubusercontent.com/yimu-0412/image/master/image/NAPT%E7%9A%84%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B.png)

&emsp;&emsp;由于NAT实现是私有IP和NAT的公共IP之间的转换，那么，私有网中同时与公共网进行通信的主机数量就受到NAT的公共IP地址数量的限制。为了克服 这种限制，NAT被进一步扩展到在进行IP地址转换的同时进行Port的转换，这就是网络地址端口转换NAPT（Network Address Port Translation）技术。

&emsp;&emsp;**NAPT与NAT的区别在于，NAPT不仅转换IP包中的IP地址，还对IP包中TCP和UDP的Port进行转换。这使得多台私有网主机利用1个NAT公共IP就可以同时和公共网进行通信。（NAPT多了对TCP和UDP的端口号的转换）**

 &emsp;&emsp;NAPT的主要优势在于，能够**使用一个全球有效IP地址获得通用性**。主要缺点在于其通信仅限于TCP或UDP。只要所有通信都采用TCP或UDP，NAPT就允许一台内部计算机访问多台外部计算机，并允许多台内部主机访问同一台外部计算机，相互之间不会发生冲突。

 ### 四、经典面试题

 1. 从浏览器输入一个 URL 之后，都发生了那些事情？
   
    1. 浏览器，首先会根据这里的域名，查询对应的 IP 地址；
   
       1. 先检查一下自身的额缓存
       2. 再查 hosts 文件
       3. 再查 DNS 服务器

    2. s浏览器构造一个 HTTP 请求，这个 HTTP 数据就包含了这个域信息（用户输入的域名）。
    3. 浏览器调用操作系统的 socket API，把这个 HTTP 数据交给 TCP 做进一步处理，TCP 协议就需要构造一个 TCP 数据报 。
     
        1. 在发送 TCP数据报之前，首先要进行“三次握手”，建立连接；（此处的“三次握手”所涉及的 SYN/ACK 同样要经过网络层、数据链路层、物理层依次封装到达对端服务器之后再依次进行分用）
        2. 具体进行传输，发送方会把这个 TCP数据交给 IP协议 进行再一次封装；
    4. 网络层把 TCP数据报封装成了一个IP数据报，进行进一步的封装，（也可能是多个IP数据报，IP 协议会进行自动分包的过程）然后把数据交给数据链路层。
    5. 数据链路层会进一步把这个数据封装成以太网数据帧， 在构造帧头的时候就需要根据 IP 映射 MAC 地址，这个构造的过程依赖了 ARP 协议。然后再把这个数据交给物理层传输。
    6. 物理层把数据转成电信号继续传输。
    7. 电信号沿着网线，到达下一个设备（路由器），路由器就会针对收到的数据进行分用，物理层把数据交给了数据链路层，数据链路层把数据交给了网络层，路由器拿到了网络层中的 IP数据报，取出其中的 IP地址，查询路由表，找到下一个需要传输的目标，进一步再找到下一个目表的 MAC地址，然后将数据重新封装（把数据交给数据链路层和物理层）。此时的 源MAC 和 目的MAC 已经发生更改。
    8. 数据到达接收方，仍然要进行分用。层层解析，物理层将电信号转换成以太网数据帧，交给数据链路层；数据链路层解析出 IP数据报，交给网络层（都涉及到了CRC校验，如果校验和不对，说明数据错误，直接丢弃）；IP 协议再进行解析，获得了一个 TCP 数据报（IP报头中有协议类型）；这个解析过程可能还涉及组包的过程（IP报头，16位标识，3标志位，13位片位移）再根据 TCP数据报中的端口号，找到对应的进程，把数据放入对应的 socket 的接受缓存区中。
    9. 应用程序调用对应的socket API，从 TCP接收缓冲区中读取数据，应用程序把这个数据按照 HTTP 协议来解析，获取其中的 URL，根据 URL 指定的路径，知道了要获取/的根路径。
    10. 服务器会对/这个路径进行配置，映射到一个具体的index.html这样的一个HTML文件，服务器读取这个文件，把其中的数据构造成一个 HTTP 响应数据，然后再调用 socket API 进行发送。
    11. 重复上面封装的过程，服务器发送的响应数据也要层层封装，最终变成一个物理层传输的光电信号。
    12. 光电信号到达下一个路由器，路由器重复上述的分用过程，解析到 IP 这一层，取出其中的目的IP，查路由表找到下一设备在哪里，重新封装数据。
    13. 重复这个过程，依次转发，最后达到用户的主机。
    14. 用户主机重复上面的分用过程，依次把数据取出来，最终交给应用程序。
    15. 浏览器得到了 HTTP 响应报文，解析这个报文，获得其中的 html 内容，根据 html 进行渲染

